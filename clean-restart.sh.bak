#!/bin/bash

echo "ğŸ§¹ CLEAN RESTART - Dá»«ng táº¥t cáº£ vÃ  khá»Ÿi Ä‘á»™ng láº¡i sáº¡ch sáº½"
echo "========================================================"

# 1. Dá»«ng Táº¤T Cáº¢ process liÃªn quan
echo "ğŸ›‘ Dá»«ng táº¥t cáº£ process..."
pkill -f "uvicorn" || true
pkill -f "vite" || true
pkill -f "node.*5173" || true
pkill -f "node.*5174" || true
pkill -f "python.*app.py" || true
pkill -f "python.*main" || true

# Äá»£i táº¥t cáº£ process dá»«ng hoÃ n toÃ n
echo "â³ Äá»£i process dá»«ng hoÃ n toÃ n..."
sleep 5

# 2. Kiá»ƒm tra port cÃ²n bá»‹ chiáº¿m khÃ´ng
echo "ğŸ” Kiá»ƒm tra port..."
if lsof -i :5173 > /dev/null 2>&1; then
    echo "âŒ Port 5173 váº«n bá»‹ chiáº¿m, force kill..."
    lsof -ti :5173 | xargs kill -9 2>/dev/null || true
fi

if lsof -i :8000 > /dev/null 2>&1; then
    echo "âŒ Port 8000 váº«n bá»‹ chiáº¿m, force kill..."
    lsof -ti :8000 | xargs kill -9 2>/dev/null || true
fi

# Äá»£i thÃªm
sleep 3

# 3. Kiá»ƒm tra láº¡i
echo "ğŸ” Kiá»ƒm tra láº¡i port..."
if lsof -i :5173 > /dev/null 2>&1; then
    echo "âŒ Port 5173 váº«n bá»‹ chiáº¿m!"
    exit 1
fi

if lsof -i :8000 > /dev/null 2>&1; then
    echo "âŒ Port 8000 váº«n bá»‹ chiáº¿m!"
    exit 1
fi

echo "âœ… Táº¥t cáº£ port Ä‘Ã£ Ä‘Æ°á»£c giáº£i phÃ³ng!"

# 4. Khá»Ÿi Ä‘á»™ng backend
echo "ğŸ”§ Khá»Ÿi Ä‘á»™ng backend..."
cd /Users/maybe/Documents/shopee/backend
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 8000 --ssl-keyfile ../ssl/server.key --ssl-certfile ../ssl/server.crt --reload > backend.log 2>&1 &
BACKEND_PID=$!
echo "Backend PID: $BACKEND_PID"

# Äá»£i backend khá»Ÿi Ä‘á»™ng
echo "â³ Äá»£i backend khá»Ÿi Ä‘á»™ng..."
sleep 5

# Kiá»ƒm tra backend
if curl -k -s https://10.10.68.72:8000/health | grep -q "healthy"; then
    echo "âœ… Backend khá»Ÿi Ä‘á»™ng thÃ nh cÃ´ng!"
else
    echo "âŒ Backend khá»Ÿi Ä‘á»™ng tháº¥t báº¡i!"
    exit 1
fi

# 5. Khá»Ÿi Ä‘á»™ng frontend
echo "ğŸ¨ Khá»Ÿi Ä‘á»™ng frontend..."
cd /Users/maybe/Documents/shopee/frontend
npm run dev -- --host 0.0.0.0 --port 5173 --https > frontend.log 2>&1 &
FRONTEND_PID=$!
echo "Frontend PID: $FRONTEND_PID"

# Äá»£i frontend khá»Ÿi Ä‘á»™ng
echo "â³ Äá»£i frontend khá»Ÿi Ä‘á»™ng..."
sleep 5

# Kiá»ƒm tra frontend
if curl -k -s https://10.10.68.72:5173 > /dev/null; then
    echo "âœ… Frontend khá»Ÿi Ä‘á»™ng thÃ nh cÃ´ng!"
else
    echo "âŒ Frontend khá»Ÿi Ä‘á»™ng tháº¥t báº¡i!"
    exit 1
fi

# 6. Test há»‡ thá»‘ng
echo "ğŸ§ª Test há»‡ thá»‘ng..."
cd /Users/maybe/Documents/shopee
./quick-test.sh

echo ""
echo "ğŸ‰ CLEAN RESTART HOÃ€N Táº¤T!"
echo "=========================="
echo "ğŸ“± Frontend: https://10.10.68.72:5173"
echo "ğŸ”§ Backend: https://10.10.68.72:8000"
echo "ğŸ“Š API Docs: https://10.10.68.72:8000/docs"
echo ""
echo "ğŸ›‘ Äá»ƒ dá»«ng há»‡ thá»‘ng:"
echo "   kill $BACKEND_PID $FRONTEND_PID"
echo ""
echo "ğŸ’¡ Hoáº·c cháº¡y: ./clean-restart.sh Ä‘á»ƒ restart láº¡i"
