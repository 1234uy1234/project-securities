#!/usr/bin/env python3
"""
Script táº¡o QR code cho tá»«ng vá»‹ trÃ­ - LOGIC Má»šI ÄÆ N GIáº¢N
Má»—i QR code sáº½ chá»©a location_id Ä‘á»ƒ checkin chÃ­nh xÃ¡c
"""

import os
import sys
import qrcode
from datetime import datetime
import requests
import json

# ThÃªm path Ä‘á»ƒ import modules
sys.path.append('/Users/maybe/Documents/shopee/backend')

def create_qr_for_location(location_id: int, location_name: str, base_url: str = "https://10.10.68.106:8000"):
    """Táº¡o QR code cho má»™t vá»‹ trÃ­ cá»¥ thá»ƒ"""
    
    print(f"ğŸ”§ Táº¡o QR code cho vá»‹ trÃ­: {location_name} (ID: {location_id})")
    
    # QR content Ä‘Æ¡n giáº£n - chá»‰ chá»©a location_id
    qr_content = str(location_id)
    
    # Táº¡o QR code
    qr = qrcode.QRCode(
        version=1,
        error_correction=qrcode.constants.ERROR_CORRECT_L,
        box_size=10,
        border=4,
    )
    qr.add_data(qr_content)
    qr.make(fit=True)
    
    # Táº¡o áº£nh
    img = qr.make_image(fill_color="black", back_color="white")
    
    # Táº¡o tÃªn file
    safe_name = location_name.replace(" ", "_").replace("/", "_").lower()
    filename = f"location_{location_id:02d}_{safe_name}.png"
    
    # LÆ°u vÃ o thÆ° má»¥c uploads/qr_codes
    upload_dir = "/Users/maybe/Documents/shopee/uploads/qr_codes"
    os.makedirs(upload_dir, exist_ok=True)
    
    file_path = os.path.join(upload_dir, filename)
    img.save(file_path)
    
    print(f"âœ… QR code Ä‘Ã£ táº¡o: {filename}")
    print(f"   Content: {qr_content}")
    print(f"   File: {file_path}")
    
    return {
        "location_id": location_id,
        "location_name": location_name,
        "qr_content": qr_content,
        "filename": filename,
        "file_path": file_path
    }

def create_all_location_qr_codes():
    """Táº¡o QR code cho táº¥t cáº£ vá»‹ trÃ­"""
    
    print("ğŸš€ Táº O QR CODE CHO Táº¤T Cáº¢ Vá»Š TRÃ")
    print("=" * 50)
    
    # Danh sÃ¡ch vá»‹ trÃ­ cá»‘ Ä‘á»‹nh
    locations = [
        {"id": 1, "name": "Cá»•ng chÃ­nh"},
        {"id": 2, "name": "NhÃ  Äƒn"},
        {"id": 3, "name": "Kho hÃ ng"},
        {"id": 4, "name": "VÄƒn phÃ²ng"},
        {"id": 5, "name": "XÆ°á»Ÿng sáº£n xuáº¥t"},
        {"id": 6, "name": "BÃ£i Ä‘á»— xe"},
        {"id": 7, "name": "Khu vá»±c nghá»‰ ngÆ¡i"},
        {"id": 8, "name": "PhÃ²ng há»p"},
        {"id": 9, "name": "Khu vá»±c an toÃ n"},
        {"id": 10, "name": "Cá»•ng phá»¥"}
    ]
    
    created_qr_codes = []
    
    for location in locations:
        try:
            qr_data = create_qr_for_location(
                location["id"], 
                location["name"]
            )
            created_qr_codes.append(qr_data)
        except Exception as e:
            print(f"âŒ Lá»—i táº¡o QR cho {location['name']}: {str(e)}")
    
    print("\nğŸ“‹ Tá»”NG Káº¾T:")
    print("=" * 50)
    print(f"âœ… ÄÃ£ táº¡o {len(created_qr_codes)} QR codes")
    
    for qr in created_qr_codes:
        print(f"   - {qr['location_name']}: {qr['qr_content']} â†’ {qr['filename']}")
    
    print("\nğŸ¯ CÃCH Sá»¬ Dá»¤NG:")
    print("=" * 50)
    print("1. In QR code ra giáº¥y")
    print("2. DÃ¡n táº¡i vá»‹ trÃ­ tÆ°Æ¡ng á»©ng")
    print("3. Employee quÃ©t QR â†’ chá»¥p áº£nh â†’ checkin")
    print("4. Há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng:")
    print("   - TÃ¬m Ä‘Ãºng vá»‹ trÃ­ tá»« QR content")
    print("   - TÃ¬m task cá»§a employee táº¡i vá»‹ trÃ­ Ä‘Ã³")
    print("   - LÆ°u áº£nh vÃ  thá»i gian checkin")
    print("   - Cáº­p nháº­t tráº¡ng thÃ¡i task")
    
    return created_qr_codes

def test_qr_content():
    """Test QR content Ä‘á»ƒ Ä‘áº£m báº£o logic Ä‘Ãºng"""
    
    print("\nğŸ§ª TEST QR CONTENT:")
    print("=" * 50)
    
    test_contents = ["1", "2", "3", "10"]
    
    for content in test_contents:
        print(f"QR Content: '{content}'")
        
        # Simulate logic tá»« backend
        try:
            location_id = int(content)
            print(f"  â†’ Parsed location_id: {location_id}")
            print(f"  â†’ Valid: âœ…")
        except ValueError:
            print(f"  â†’ Invalid: âŒ")
        print()

if __name__ == "__main__":
    try:
        # Táº¡o QR codes
        qr_codes = create_all_location_qr_codes()
        
        # Test logic
        test_qr_content()
        
        print("\nğŸ‰ HOÃ€N THÃ€NH!")
        print("QR codes Ä‘Ã£ Ä‘Æ°á»£c táº¡o vÃ  sáºµn sÃ ng sá»­ dá»¥ng!")
        
    except Exception as e:
        print(f"âŒ Lá»—i: {str(e)}")
        sys.exit(1)
