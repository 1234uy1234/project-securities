#!/bin/bash

# Script cuá»‘i cÃ¹ng Ä‘á»ƒ khá»Ÿi Ä‘á»™ng frontend vá»›i HTTPS
echo "ğŸ” KHá»I Äá»˜NG FRONTEND Vá»šI HTTPS - Láº¦N CUá»I"
echo "=========================================="

# Chuyá»ƒn Ä‘áº¿n thÆ° má»¥c dá»± Ã¡n
cd "$(dirname "$0")"

# Láº¥y IP hiá»‡n táº¡i
CURRENT_IP=$(ifconfig | grep "inet " | grep -v 127.0.0.1 | head -1 | awk '{print $2}')
echo "ğŸ“ IP hiá»‡n táº¡i: $CURRENT_IP"

# Dá»«ng táº¥t cáº£ process cÅ©
echo "â¹ï¸  Dá»«ng táº¥t cáº£ process cÅ©..."
pkill -f "vite" 2>/dev/null || true
pkill -f "npm.*dev" 2>/dev/null || true
sleep 3

# Táº¡o SSL certificate má»›i náº¿u cáº§n
echo "ğŸ” Kiá»ƒm tra SSL certificate..."
if [ ! -f "ssl/server.crt" ] || [ ! -f "ssl/server.key" ]; then
    echo "Táº¡o SSL certificate má»›i..."
    ./update-ssl-cert.sh
fi

# Khá»Ÿi Ä‘á»™ng frontend vá»›i HTTPS
echo "ğŸš€ Khá»Ÿi Ä‘á»™ng frontend vá»›i HTTPS..."
cd frontend

# Sá»­ dá»¥ng config gá»‘c vá»›i HTTPS
VITE_API_BASE_URL="https://$CURRENT_IP:8000" npm run dev -- --host $CURRENT_IP --port 5173 --https &
FRONTEND_PID=$!
cd ..

# Äá»£i frontend khá»Ÿi Ä‘á»™ng
echo "â³ Äá»£i frontend khá»Ÿi Ä‘á»™ng..."
sleep 10

# Kiá»ƒm tra frontend
echo "ğŸ” Kiá»ƒm tra frontend..."
if curl -s -k "https://$CURRENT_IP:5173" > /dev/null 2>&1; then
    echo "âœ… Frontend Ä‘Ã£ khá»Ÿi Ä‘á»™ng thÃ nh cÃ´ng vá»›i HTTPS"
    echo "ğŸŒ Truy cáº­p: https://$CURRENT_IP:5173"
    echo ""
    echo "ğŸ‰ THÃ€NH CÃ”NG! á»¨ng dá»¥ng Ä‘Ã£ cháº¡y vá»›i HTTPS:"
    echo "   Frontend: https://$CURRENT_IP:5173"
    echo "   Backend:  https://$CURRENT_IP:8000"
    echo ""
    echo "âš ï¸  Náº¿u trÃ¬nh duyá»‡t bÃ¡o 'khÃ´ng an toÃ n':"
    echo "   1. Báº¥m 'Tiáº¿p tá»¥c' hoáº·c 'Advanced'"
    echo "   2. Báº¥m 'Proceed to 10.10.68.72 (unsafe)'"
    echo "   3. Hoáº·c báº¥m 'Accept Risk and Continue'"
else
    echo "âŒ Frontend khá»Ÿi Ä‘á»™ng tháº¥t báº¡i vá»›i HTTPS"
    echo "ğŸ”„ Thá»­ vá»›i HTTP..."
    
    # Dá»«ng HTTPS vÃ  thá»­ HTTP
    pkill -f "vite" 2>/dev/null || true
    sleep 3
    
    cd frontend
    VITE_API_BASE_URL="https://$CURRENT_IP:8000" npm run dev -- --host $CURRENT_IP --port 5173 &
    FRONTEND_PID=$!
    cd ..
    
    sleep 5
    
    if curl -s "http://$CURRENT_IP:5173" > /dev/null 2>&1; then
        echo "âœ… Frontend Ä‘Ã£ khá»Ÿi Ä‘á»™ng thÃ nh cÃ´ng vá»›i HTTP"
        echo "ğŸŒ Truy cáº­p: http://$CURRENT_IP:5173"
        echo ""
        echo "âš ï¸  Frontend cháº¡y vá»›i HTTP (khÃ´ng cÃ³ s)"
        echo "   Truy cáº­p: http://$CURRENT_IP:5173"
    else
        echo "âŒ Frontend khá»Ÿi Ä‘á»™ng tháº¥t báº¡i hoÃ n toÃ n"
        echo "ğŸ”§ HÃ£y kiá»ƒm tra log Ä‘á»ƒ xem lá»—i"
    fi
fi

echo "ğŸ¨ Frontend PID: $FRONTEND_PID"
