import React, { useEffect, useRef, useState } from 'react'
import { BrowserMultiFormatReader, IScannerControls } from '@zxing/browser'
import Webcam from 'react-webcam'
import { useNavigate, useSearchParams } from 'react-router-dom'
import toast from 'react-hot-toast'
import { api } from '../utils/api'
import { getCurrentPosition } from '../utils/geo'
import { enqueueScan, flushQueue, setupOnlineSync } from '../utils/offlineQueue'
import { useAuthStore } from '../stores/authStore'
import ScanCamera from '../components/ScanCamera'
import SimpleMobileCamera from '../components/SimpleMobileCamera'

const QRScannerPage = () => {
  const navigate = useNavigate()
  const photoWebcamRef = useRef<Webcam | null>(null)
  const scannerRef = useRef<any>(null) // Th√™m scannerRef
  const [photoCameraActive, setPhotoCameraActive] = useState(false)
  const [photoWebcamError, setPhotoWebcamError] = useState<string | null>(null)
  const [lastResult, setLastResult] = useState<string>('')
  const [notes, setNotes] = useState('')
  const [capturedPhoto, setCapturedPhoto] = useState<string | null>(null)
  const [photoFacingMode, setPhotoFacingMode] = useState<'user' | 'environment'>('environment')
  
  // Flow steps v√† status
  const [currentStep, setCurrentStep] = useState<'scan' | 'photo' | 'submit' | 'success'>('scan')
  const [isSubmitting, setIsSubmitting] = useState(false)
  
  // Th√¥ng tin nhi·ªám v·ª• t·ª´ QR scan
  const [currentLocation, setCurrentLocation] = useState<any>(null)
  const [currentTasks, setCurrentTasks] = useState<any[]>([])
  const [showTaskInfo, setShowTaskInfo] = useState(false)
  
  // L·∫•y ref t·ª´ URL params
  const [searchParams] = useSearchParams()
  const ref = searchParams.get('ref')
  
  // State ƒë·ªÉ l∆∞u QR content ƒë√£ qu√©t
  const [scannedQRContent, setScannedQRContent] = useState<string | null>(null)
  
  // Location info
  const [locationInfo, setLocationInfo] = useState<{
    name: string;
    address: string;
    gps: { lat: number; lng: number };
    scannedAt: string;
  } | null>(null)
  
  // Camera state
  const [isCameraActive, setIsCameraActive] = useState(false)

  // Kh√¥i ph·ª•c th√¥ng tin t·ª´ localStorage khi component mount
  useEffect(() => {
    const savedLocation = localStorage.getItem('lastScannedLocation')
    const savedQR = localStorage.getItem('lastScannedQR')
    
    if (savedLocation && savedQR) {
      try {
        const locationData = JSON.parse(savedLocation)
        setLocationInfo(locationData)
        setScannedQRContent(savedQR)
        setLastResult(savedQR)
        console.log('Kh√¥i ph·ª•c th√¥ng tin v·ªã tr√≠ t·ª´ localStorage:', locationData)
      } catch (error) {
        console.error('L·ªói kh√¥i ph·ª•c th√¥ng tin:', error)
      }
    }
  }, [])

  // B·∫≠t camera ch·ª•p ·∫£nh ƒë∆°n gi·∫£n
  const enablePhotoCamera = async () => {
    try {
      console.log('üé• Enabling Simple Photo Camera...')
      setPhotoWebcamError(null)
      
      // SimpleMobileCamera s·∫Ω t·ª± ƒë·ªông d·ª´ng t·∫•t c·∫£ streams
      setPhotoCameraActive(true)
      console.log('‚úÖ Simple Photo Camera enabled')
    } catch (err: any) {
      console.error('‚ùå Photo Camera error:', err)
      setPhotoWebcamError('L·ªói camera: ' + err.message)
    }
  }
  
  // Chuy·ªÉn ƒë·ªïi camera tr∆∞·ªõc/sau cho QR Scanner
  const switchCamera = () => {
    // This function is for QR scanner camera, not photo camera
    console.log('üîÑ Switching QR Scanner camera')
  }

  // T·∫Øt camera ch·ª•p ·∫£nh ƒë∆°n gi·∫£n
  const disablePhotoCamera = async () => {
    console.log('‚èπÔ∏è Disabling Simple Photo Camera...')
    setPhotoCameraActive(false)
    setPhotoWebcamError(null)
    
    // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ camera d·ª´ng ho√†n to√†n
    await new Promise(resolve => setTimeout(resolve, 300))
    
    console.log('‚úÖ Simple Photo Camera disabled')
  }

  // Chuy·ªÉn ƒë·ªïi camera tr∆∞·ªõc/sau cho Photo
  const switchPhotoCamera = () => {
    setPhotoFacingMode(prev => prev === 'environment' ? 'user' : 'environment')
    if (photoCameraActive) {
      setPhotoCameraActive(false)
      setTimeout(() => setPhotoCameraActive(true), 100)
    }
  }

  // X·ª≠ l√Ω l·ªói camera Photo
  const handlePhotoWebcamError = (err: any) => {
    console.error('Photo Webcam error:', err)
    let errorMessage = 'L·ªói camera ch·ª•p ·∫£nh: '
    
    if (err.name === 'NotAllowedError') {
      errorMessage += 'Quy·ªÅn truy c·∫≠p b·ªã t·ª´ ch·ªëi'
    } else if (err.name === 'NotFoundError') {
      errorMessage += 'Kh√¥ng t√¨m th·∫•y camera'
    } else if (err.name === 'NotReadableError') {
      errorMessage += 'Camera ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng'
    } else if (err.name === 'NotSupportedError') {
      errorMessage += 'Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£'
    } else if (err.name === 'OverconstrainedError') {
      errorMessage += 'ƒê·ªô ph√¢n gi·∫£i kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£'
    } else {
      errorMessage += err.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'
    }
    
    setPhotoWebcamError(errorMessage)
    setPhotoCameraActive(false)
  }

  // X·ª≠ l√Ω k·∫øt qu·∫£ qu√©t QR t·ª´ ScanCamera
  const handleQRScan = async (result: string) => {
    console.log('QR Code scanned:', result)
    
    try {
      // Ki·ªÉm tra QR code c√≥ h·ª£p l·ªá kh√¥ng
      const qrResponse = await api.get(`/qr-codes/validate/${encodeURIComponent(result)}`)
      const qrData = qrResponse.data
      
      if (!qrData || !qrData.valid) {
        toast.error(`‚ùå QR code kh√¥ng h·ª£p l·ªá: ${result}`)
        return
      }
      
      // Ki·ªÉm tra xem QR code c√≥ ƒë√∫ng ch·ªó kh√¥ng (n·∫øu c√≥ location_id t·ª´ URL)
      const locationId = searchParams.get('location_id')
      if (locationId && qrData.location_id && qrData.location_id.toString() !== locationId) {
        toast.error(`‚ùå QR code kh√¥ng ƒë√∫ng ch·ªó! QR n√†y thu·ªôc v·ªã tr√≠ kh√°c.`)
        return
      }
      
      setLastResult(result)
      setScannedQRContent(result)
      setCurrentStep('photo') // Move to photo step
      
      // Hi·ªÉn th·ªã th√¥ng tin v·ªã tr√≠ - qu√©t t√™n g√¨ hi·ªÉn th·ªã t√™n ƒë√≥
      const locationData = {
        name: qrData.data || qrData.content || result, // Hi·ªÉn th·ªã t√™n th·∫≠t c·ªßa QR
        address: `ƒê√£ qu√©t QR: ${qrData.data || qrData.content || result}`,
        gps: { lat: 0, lng: 0 },
        scannedAt: new Date().toLocaleString('vi-VN')
      }
      setLocationInfo(locationData)
      
      // L∆∞u v√†o localStorage
      localStorage.setItem('lastScannedLocation', JSON.stringify(locationData))
      localStorage.setItem('lastScannedQR', result)
      
      // Hi·ªÉn th·ªã th√¥ng b√°o ngay l·∫≠p t·ª©c
      toast.success(`‚úÖ ƒê√£ qu√©t QR: ${qrData.data || qrData.content || result}`)
      
    } catch (error: any) {
      console.error('Error validating QR code:', error)
      toast.error(`‚ùå L·ªói x√°c th·ª±c QR code: ${error.response?.data?.detail || error.message}`)
    }
  }

  // X·ª≠ l√Ω l·ªói qu√©t QR
  const handleQRScanError = (error: string) => {
    console.error('QR Scan error:', error)
    setPhotoWebcamError(error)
  }

  // Ch·ª•p ·∫£nh v·ªõi OptimizedCamera
  const capturePhoto = () => {
    console.log('üì∑ CAPTURE PHOTO: Starting with OptimizedCamera...')
    
    // T·∫°o canvas ƒë·ªÉ capture t·ª´ video element
    const videoElement = document.querySelector('video') as HTMLVideoElement
    if (!videoElement) {
      console.error('üì∑ CAPTURE PHOTO: No video element found')
      toast.error('Kh√¥ng t√¨m th·∫•y video element')
      return
    }
    
    try {
      const canvas = document.createElement('canvas')
      const ctx = canvas.getContext('2d')
      
      if (!ctx) {
        console.error('üì∑ CAPTURE PHOTO: No canvas context')
        toast.error('Kh√¥ng th·ªÉ t·∫°o canvas context')
        return
      }
      
      // Set canvas size
      canvas.width = videoElement.videoWidth
      canvas.height = videoElement.videoHeight
      
      // Draw video frame
      ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height)
      
      // Add timestamp overlay
      ctx.fillStyle = 'rgba(0, 0, 0, 0.7)'
      ctx.fillRect(10, canvas.height - 40, 200, 30)
      
      ctx.fillStyle = 'white'
      ctx.font = '14px Arial'
      ctx.fillText(
        new Date().toLocaleString('vi-VN'),
        15,
        canvas.height - 20
      )
      
      const imageSrc = canvas.toDataURL('image/jpeg', 0.9)
      console.log('üì∑ CAPTURE PHOTO: Screenshot result:', imageSrc ? 'SUCCESS' : 'FAILED')
      
      if (imageSrc) {
        setCapturedPhoto(imageSrc)
        console.log('üì∑ CAPTURE PHOTO: Photo saved, length:', imageSrc.length)
        toast.success('üì∑ ƒê√£ ch·ª•p ·∫£nh th√†nh c√¥ng!')
      } else {
        console.error('üì∑ CAPTURE PHOTO: Failed to generate image')
        toast.error('Kh√¥ng th·ªÉ ch·ª•p ·∫£nh')
      }
    } catch (error) {
      console.error('üì∑ CAPTURE PHOTO: Error:', error)
      toast.error('L·ªói khi ch·ª•p ·∫£nh: ' + (error as Error).message)
    }
  }

  // X√≥a ·∫£nh ƒë√£ ch·ª•p
  const clearPhoto = () => {
    setCapturedPhoto(null)
  }

  // G·ª≠i d·ªØ li·ªáu check-in - ƒê∆°n gi·∫£n
  const submitCheckin = async () => {
    console.log('üöÄ SUBMIT CHECKIN: Starting...')
    console.log('üöÄ SUBMIT CHECKIN: scannedQRContent:', scannedQRContent)
    console.log('üöÄ SUBMIT CHECKIN: capturedPhoto:', capturedPhoto ? 'YES' : 'NO')
    console.log('üöÄ SUBMIT CHECKIN: capturedPhoto length:', capturedPhoto ? capturedPhoto.length : 0)
    
    if (!scannedQRContent) {
      toast.error('Vui l√≤ng qu√©t QR code tr∆∞·ªõc!')
      return
    }

    // B·∫Øt bu·ªôc ch·ª•p ·∫£nh tr∆∞·ªõc khi checkin - KH√îNG CHO PH√âP B·ªé QUA
    if (!capturedPhoto || capturedPhoto.trim() === '') {
      toast.error('üì∑ PH·∫¢I CH·ª§P ·∫¢NH tr∆∞·ªõc khi checkin! Kh√¥ng ƒë∆∞·ª£c b·ªè qua!')
      setCurrentStep('photo')
      // B·∫Øt bu·ªôc b·∫≠t camera
      if (!photoCameraActive) {
        await enablePhotoCamera()
      }
      return
    }
    
    // Ki·ªÉm tra ·∫£nh c√≥ h·ª£p l·ªá kh√¥ng
    if (!capturedPhoto.startsWith('data:image/')) {
      toast.error('üì∑ ·∫¢nh kh√¥ng h·ª£p l·ªá! Vui l√≤ng ch·ª•p l·∫°i!')
      setCapturedPhoto(null)
      setCurrentStep('photo')
      return
    }

    // Debug: Ki·ªÉm tra authentication
    const authStore = useAuthStore.getState()
    const token = authStore.token || localStorage.getItem('access_token')
    console.log('üîç CHECKIN DEBUG:')
    console.log('- User:', authStore.user)
    console.log('- Token:', token ? 'Present' : 'Missing')
    console.log('- IsAuthenticated:', authStore.isAuthenticated)
    
    if (!token) {
      toast.error('‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.')
      navigate('/login')
      return
    }

    setIsSubmitting(true)
    setCurrentStep('submit')

    try {
      // G·ª≠i d·ªØ li·ªáu ƒë∆°n gi·∫£n - ch·ªâ c·∫ßn QR content
      const formData = new FormData()
      
      // Validation v√† debug
      console.log('üì§ QR Content:', scannedQRContent)
      console.log('üì§ QR Content type:', typeof scannedQRContent)
      console.log('üì§ Captured Photo:', capturedPhoto ? 'YES' : 'NO')
      console.log('üì§ Photo length:', capturedPhoto ? capturedPhoto.length : 0)
      
      // Cho ph√©p QR data r·ªóng ho·∫∑c ch·ªâ c√≥ space - S·ª¨A TRI·ªÜT ƒê·ªÇ
      let qrData = ''
      
      if (scannedQRContent) {
        // Ki·ªÉm tra c√°c tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát
        if (scannedQRContent === 'None' || scannedQRContent === 'null' || scannedQRContent === 'undefined') {
          qrData = ''
        } else {
          qrData = scannedQRContent.trim()
        }
      }
      
      formData.append('qr_data', qrData)
      
      console.log('üì§ Original scannedQRContent:', scannedQRContent)
      console.log('üì§ Final QR Data:', qrData)
      console.log('üì§ QR Data type:', typeof qrData)
      console.log('üì§ QR Data length:', qrData.length)
      
      // B·∫ÆT BU·ªòC g·ª≠i ·∫£nh - debug chi ti·∫øt
      console.log('üì§ Photo validation:')
      console.log('  - capturedPhoto:', capturedPhoto ? 'EXISTS' : 'NULL')
      console.log('  - capturedPhoto type:', typeof capturedPhoto)
      console.log('  - capturedPhoto length:', capturedPhoto ? capturedPhoto.length : 0)
      console.log('  - starts with data:image/:', capturedPhoto ? capturedPhoto.startsWith('data:image/') : false)
      
      if (capturedPhoto && capturedPhoto.startsWith('data:image/')) {
        try {
          // Convert base64 to blob
          console.log('üì§ Converting base64 to blob...')
          const response = await fetch(capturedPhoto)
          const blob = await response.blob()
          
          console.log('üì§ Blob created:')
          console.log('  - blob size:', blob.size, 'bytes')
          console.log('  - blob type:', blob.type)
          console.log('  - blob is valid:', blob.size > 0)
          
          if (blob.size > 0) {
            formData.append('photo', blob, 'photo.jpg')
            console.log('üì§ Photo added to FormData')
          } else {
            throw new Error('Blob is empty')
          }
        } catch (error) {
          console.log('‚ùå Error converting photo:', error)
          toast.error('‚ùå L·ªñI CHUY·ªÇN ƒê·ªîI ·∫¢NH! Vui l√≤ng ch·ª•p l·∫°i!')
          setCurrentStep('photo')
          return
        }
      } else {
        console.log('‚ùå NO PHOTO TO SEND!')
        console.log('‚ùå CapturedPhoto value:', capturedPhoto)
        toast.error('‚ùå KH√îNG C√ì ·∫¢NH ƒê·ªÇ G·ª¨I! Vui l√≤ng ch·ª•p l·∫°i!')
        setCurrentStep('photo')
        return
      }
      
      console.log('üì§ Sending checkin request...')
      console.log('üì§ Captured photo:', capturedPhoto ? 'YES' : 'NO')
      console.log('üì§ FormData entries:')
      for (let [key, value] of formData.entries()) {
        console.log(`  ${key}:`, value)
      }
      
      // Debug: Ki·ªÉm tra FormData c√≥ photo kh√¥ng
      const hasPhoto = formData.has('photo')
      console.log('üì§ FormData has photo:', hasPhoto)
      
      // Debug: Ki·ªÉm tra token
      const token = localStorage.getItem('token')
      console.log('üì§ Token exists:', !!token)
      console.log('üì§ Token preview:', token ? token.substring(0, 20) + '...' : 'None')
      
      if (!hasPhoto) {
        console.log('‚ùå FormData kh√¥ng c√≥ photo!')
        toast.error('‚ùå L·ªñI: Kh√¥ng c√≥ ·∫£nh trong FormData!')
        setCurrentStep('photo')
        return
      }
      
      const response = await api.post('/checkin/simple', formData)
      
      // Success!
      setCurrentStep('success')
      toast.success('üéâ Check-in th√†nh c√¥ng!')
      
      // Refresh data ƒë·ªÉ c·∫≠p nh·∫≠t UI
      try {
        // Trigger refresh cho c√°c component kh√°c
        window.dispatchEvent(new CustomEvent('checkin-success', { 
          detail: { 
            qrData: qrData,
            photo: capturedPhoto ? 'YES' : 'NO',
            timestamp: new Date().toISOString()
          } 
        }))
        
        // Refresh page data n·∫øu c·∫ßn
        if (window.location.pathname.includes('/tasks') || window.location.pathname.includes('/admin')) {
          window.location.reload()
        }
      } catch (refreshError) {
        console.log('Refresh error (non-critical):', refreshError)
      }
      
      // Reset form after 2 seconds
      setTimeout(() => {
        setScannedQRContent(null)
        setNotes('')
        setCapturedPhoto(null)
        setLastResult('')
        setLocationInfo(null)
        setCurrentStep('scan')
        setIsSubmitting(false)
        localStorage.removeItem('lastScannedLocation')
        localStorage.removeItem('lastScannedQR')
      }, 2000)
      
    } catch (error: any) {
      console.error('‚ùå Checkin error:', error)
      console.error('‚ùå Error response:', error.response?.data)
      console.error('‚ùå Error status:', error.response?.status)
      console.error('‚ùå Error message:', error.message)
      
      let errorMessage = 'C√≥ l·ªói x·∫£y ra khi ch·∫•m c√¥ng'
      
      if (error.response?.status === 422) {
        errorMessage = `L·ªói 422: ${error.response?.data?.detail || 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá'}`
        console.error('‚ùå 422 Error details:', error.response?.data)
      } else if (error.response?.status === 401) {
        errorMessage = 'L·ªói 401: Token h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i'
        // T·ª± ƒë·ªông logout v√† redirect
        localStorage.removeItem('token')
        localStorage.removeItem('user')
        window.location.href = '/login'
        return
      } else if (error.response?.status === 400) {
        errorMessage = `L·ªói 400: ${error.response?.data?.detail || 'D·ªØ li·ªáu kh√¥ng ƒë√∫ng'}`
        console.error('‚ùå 400 Error details:', error.response?.data)
      } else if (error.response?.data?.detail) {
        errorMessage = error.response.data.detail
        console.error('‚ùå Other error details:', error.response?.data)
      }
      
      toast.error(`‚ùå ${errorMessage}`)
      setCurrentStep('photo') // Go back to photo step
      setIsSubmitting(false)
    }
  }

  return (
    <div className="min-h-screen bg-gray-100 p-4">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-lg shadow-md p-4 mb-4">
          <div className="flex items-center justify-between">
            <h1 className="text-2xl font-bold text-gray-800">Qu√©t QR Code</h1>
            <button
              onClick={() => navigate('/dashboard')}
              className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
            >
              ‚Üê Quay l·∫°i
            </button>
          </div>
          
          {/* Flow Steps Indicator */}
          <div className="mt-4">
            <div className="flex items-center justify-center space-x-4">
              <div className={`flex items-center space-x-2 px-4 py-2 rounded-lg ${
                currentStep === 'scan' ? 'bg-blue-100 text-blue-800' : 
                currentStep === 'photo' || currentStep === 'submit' || currentStep === 'success' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'
              }`}>
                <span className="text-lg">üì±</span>
                <span className="font-medium">1. Qu√©t QR</span>
                {currentStep === 'scan' && <span className="animate-pulse">‚è≥</span>}
                {(currentStep === 'photo' || currentStep === 'submit' || currentStep === 'success') && <span>‚úÖ</span>}
              </div>
              
              <div className={`w-8 h-0.5 ${
                currentStep === 'photo' || currentStep === 'submit' || currentStep === 'success' ? 'bg-green-500' : 'bg-gray-300'
              }`}></div>
              
              <div className={`flex items-center space-x-2 px-4 py-2 rounded-lg ${
                currentStep === 'photo' ? 'bg-blue-100 text-blue-800' : 
                currentStep === 'submit' || currentStep === 'success' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'
              }`}>
                <span className="text-lg">üì∑</span>
                <span className="font-medium">2. Ch·ª•p ·∫£nh</span>
                {currentStep === 'photo' && <span className="animate-pulse">‚è≥</span>}
                {(currentStep === 'submit' || currentStep === 'success') && <span>‚úÖ</span>}
              </div>
              
              <div className={`w-8 h-0.5 ${
                currentStep === 'submit' || currentStep === 'success' ? 'bg-green-500' : 'bg-gray-300'
              }`}></div>
              
              <div className={`flex items-center space-x-2 px-4 py-2 rounded-lg ${
                currentStep === 'submit' ? 'bg-blue-100 text-blue-800' : 
                currentStep === 'success' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'
              }`}>
                <span className="text-lg">üì§</span>
                <span className="font-medium">3. G·ª≠i b√°o c√°o</span>
                {currentStep === 'submit' && <span className="animate-pulse">‚è≥</span>}
                {currentStep === 'success' && <span>‚úÖ</span>}
              </div>
            </div>
          </div>
        </div>

        {/* QR Scanner - Using ScanCamera */}
        <div className="bg-white rounded-lg shadow-md p-4 mb-4">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-semibold">Camera Qu√©t QR</h2>
            <div className="flex gap-2">
              <button
                onClick={() => setIsCameraActive(!isCameraActive)}
                className={`px-4 py-2 rounded-lg font-medium ${
                  isCameraActive 
                    ? 'bg-red-500 text-white hover:bg-red-600' 
                    : 'bg-green-500 text-white hover:bg-green-600'
                }`}
              >
                {isCameraActive ? '‚èπÔ∏è T·∫Øt Camera' : 'üì∑ B·∫≠t Camera'}
              </button>
              <button
                onClick={() => {
                  setLocationInfo(null)
                  setScannedQRContent(null)
                  setLastResult('')
                  localStorage.removeItem('lastScannedLocation')
                  localStorage.removeItem('lastScannedQR')
                }}
                className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
              >
                üîÑ Qu√©t QR m·ªõi
              </button>
            </div>
          </div>
          
          <div className="relative h-96">
            {isCameraActive ? (
              <ScanCamera
                onDecode={handleQRScan}
                onError={handleQRScanError}
                isActive={true}
              />
            ) : (
              <div className="w-full h-full bg-gray-200 rounded-lg flex items-center justify-center">
                <div className="text-center">
                  <div className="text-6xl mb-4">üì∑</div>
                  <p className="text-gray-600">Nh·∫•n "B·∫≠t Camera" ƒë·ªÉ b·∫Øt ƒë·∫ßu qu√©t QR</p>
                </div>
              </div>
            )}
          </div>
          
          {/* Hi·ªÉn th·ªã v·ªã tr√≠ v·ª´a qu√©t ngay d∆∞·ªõi camera */}
          {locationInfo && (
            <div className="mt-4 p-3 bg-green-100 border border-green-300 rounded-lg">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <span className="text-green-600">‚úÖ</span>
                  <span className="font-medium text-green-800">
                    ƒê√£ qu√©t QR: {locationInfo.name}
                  </span>
                </div>
                <button
                  onClick={() => {
                    setLocationInfo(null)
                    setScannedQRContent(null)
                    setLastResult('')
                    localStorage.removeItem('lastScannedLocation')
                    localStorage.removeItem('lastScannedQR')
                  }}
                  className="px-2 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600"
                >
                  ‚úï
                </button>
              </div>
              <div className="text-sm text-green-600 mt-1">
                Th·ªùi gian: {locationInfo.scannedAt}
              </div>
            </div>
          )}
        </div>



        {/* Task Info - Nhi·ªám v·ª• li√™n quan */}
        {showTaskInfo && currentTasks.length > 0 && (
          <div className="bg-white rounded-lg shadow-md p-4 mb-4">
            <h3 className="text-lg font-semibold mb-2">üìã Nhi·ªám v·ª• li√™n quan:</h3>
            {currentTasks.map((task, index) => (
              <div key={index} className="border rounded-lg p-3 mb-2 bg-green-50">
                <div className="flex justify-between items-start">
                  <div>
                    <h4 className="font-medium text-green-800">{task.title}</h4>
                    <p className="text-sm text-gray-600">{task.description}</p>
                    <p className="text-xs text-gray-500 mt-1">
                      Tr·∫°ng th√°i: <span className="font-medium">{task.status}</span>
                    </p>
                  </div>
                  <div className="text-right">
                    <p className="text-xs text-gray-500">
                      Tu·∫ßn: {task.schedule_week}
                    </p>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}

        {/* Photo Capture - Ch·ª•p ·∫£nh x√°c nh·∫≠n */}
        <div className="bg-white rounded-lg shadow-md p-4 mb-4">
          <h2 className="text-lg font-semibold mb-4">üì∑ Ch·ª•p ·∫£nh x√°c nh·∫≠n</h2>
          
          <div className="flex gap-4">
            <div className="flex-1">
              {photoCameraActive ? (
                <div className="relative">
                  <SimpleMobileCamera
                    isActive={photoCameraActive}
                    onError={(error) => setPhotoWebcamError(error)}
                    onReady={() => console.log('Photo camera ready')}
                    className="w-full h-48 rounded-lg"
                    facingMode={photoFacingMode}
                  />
                  
                  <button
                    onClick={capturePhoto}
                    className="absolute bottom-2 right-2 bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 z-10"
                  >
                    üì∑
                  </button>
                  
                  <button
                    onClick={disablePhotoCamera}
                    className="absolute bottom-2 left-2 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 z-10"
                  >
                    ‚ùå
                  </button>
                </div>
              ) : (
                <div className="w-full h-48 bg-gray-200 rounded-lg flex flex-col items-center justify-center">
                  <button
                    onClick={enablePhotoCamera}
                    className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 mb-2"
                  >
                    B·∫≠t Camera
                  </button>
                  {photoWebcamError && (
                    <div className="text-red-500 text-sm text-center px-2">
                      {photoWebcamError}
                    </div>
                  )}
                </div>
              )}
            </div>
            
            <div className="flex-1">
              {capturedPhoto ? (
                <div className="relative">
                  <img
                    src={capturedPhoto}
                    alt="Captured"
                    className="w-full h-48 object-cover rounded-lg"
                  />
                  <button
                    onClick={clearPhoto}
                    className="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full hover:bg-red-600"
                  >
                    √ó
                  </button>
                  <div className="absolute bottom-2 left-2 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded">
                    {new Date().toLocaleString('vi-VN')}
                  </div>
                </div>
              ) : (
                <div className="w-full h-48 bg-gray-200 rounded-lg flex items-center justify-center">
                  <span className="text-gray-500">Ch∆∞a c√≥ ·∫£nh</span>
                </div>
              )}
            </div>
          </div>

          {photoWebcamError && (
            <div className="mt-4 p-3 bg-red-100 text-red-700 rounded-lg">
              {photoWebcamError}
            </div>
          )}

          <div className="mt-4 flex gap-2">
            <button
              onClick={switchPhotoCamera}
              className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
            >
              üîÑ Chuy·ªÉn Camera
            </button>
            {photoCameraActive && (
              <button
                onClick={disablePhotoCamera}
                className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600"
              >
                T·∫Øt Camera
              </button>
            )}
          </div>
        </div>

        {/* Notes */}
        <div className="bg-white rounded-lg shadow-md p-4 mb-4">
          <h2 className="text-lg font-semibold mb-2">Ghi ch√∫</h2>
          <textarea
            value={notes}
            onChange={(e) => setNotes(e.target.value)}
            placeholder="Nh·∫≠p ghi ch√∫..."
            className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            rows={3}
          />
        </div>

        {/* Submit */}
        {/* Success Indicator */}
        {currentStep === 'success' && (
          <div className="bg-green-100 border-2 border-green-500 rounded-lg p-6 mb-4">
            <div className="text-center">
              <div className="text-6xl mb-4">üéâ</div>
              <h2 className="text-2xl font-bold text-green-800 mb-2">Check-in th√†nh c√¥ng!</h2>
              <p className="text-green-700">B√°o c√°o ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng</p>
              <div className="mt-4">
                <div className="inline-flex items-center px-4 py-2 bg-green-500 text-white rounded-lg">
                  <span className="animate-spin mr-2">‚è≥</span>
                  ƒêang reset form...
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Submit Button */}
        <div className="bg-white rounded-lg shadow-md p-4">
          <button
            onClick={submitCheckin}
            disabled={isSubmitting || currentStep === 'success'}
            className={`w-full px-6 py-3 rounded-lg font-medium ${
              currentStep === 'success' 
                ? 'bg-gray-400 text-gray-600 cursor-not-allowed' 
                : isSubmitting 
                  ? 'bg-blue-500 text-white cursor-not-allowed' 
                  : 'bg-green-500 text-white hover:bg-green-600'
            }`}
          >
            {currentStep === 'success' ? '‚úÖ Ho√†n th√†nh' : 
             isSubmitting ? '‚è≥ ƒêang g·ª≠i...' : 'üì§ G·ª≠i Check-in'}
          </button>
        </div>
      </div>
    </div>
  )
}

export default QRScannerPage
