<!DOCTYPE html>
<html>
<head>
    <title>Test Checkin v·ªõi Token th·∫≠t</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1>Test Checkin v·ªõi Token th·∫≠t</h1>
    <video id="video" width="320" height="240" autoplay></video>
    <br>
    <button onclick="startCamera()">Start Camera</button>
    <button onclick="captureAndCheckin()">Capture & Checkin</button>
    <br>
    <canvas id="canvas" width="320" height="240" style="border:1px solid #000;"></canvas>
    <br>
    <div id="result"></div>

    <script>
        let stream = null;
        let capturedPhoto = null;
        
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                document.getElementById('result').innerHTML = '‚úÖ Camera started successfully';
            } catch (err) {
                document.getElementById('result').innerHTML = '‚ùå Camera error: ' + err.message;
                console.error('Camera error:', err);
            }
        }
        
        async function captureAndCheckin() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            if (!video.videoWidth || !video.videoHeight) {
                document.getElementById('result').innerHTML = '‚ùå Video not ready';
                return;
            }
            
            // Capture photo
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            if (!imageData || !imageData.startsWith('data:image/')) {
                document.getElementById('result').innerHTML = '‚ùå Failed to capture photo';
                return;
            }
            
            capturedPhoto = imageData;
            document.getElementById('result').innerHTML = '‚úÖ Photo captured! Length: ' + imageData.length;
            
            // Test checkin
            try {
                const formData = new FormData();
                formData.append('qr_data', 'test_sample_data');
                formData.append('notes', 'Test v·ªõi d·ªØ li·ªáu m·∫´u');
                
                // Convert base64 to blob
                const response = await fetch(imageData);
                const blob = await response.blob();
                
                if (blob.size > 0) {
                    formData.append('photo', blob, 'photo.jpg');
                    
                    console.log('üì§ FormData entries:');
                    for (let [key, value] of formData.entries()) {
                        console.log(`  ${key}:`, value);
                    }
                    
                    const checkinResponse = await fetch('https://10.10.68.200:8000/api/checkin/simple', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsImV4cCI6MTc1OTE5NTgyMX0.F643JKP6DYeKNGTg0q138ubcFkfc2of-cx7p2ywB91E'
                        },
                        body: formData
                    });
                    
                    const data = await checkinResponse.json();
                    
                    if (data.photo_url) {
                        document.getElementById('result').innerHTML = '‚úÖ Checkin successful! Photo URL: ' + data.photo_url;
                    } else {
                        document.getElementById('result').innerHTML = '‚ùå Checkin failed: ' + JSON.stringify(data);
                    }
                } else {
                    document.getElementById('result').innerHTML = '‚ùå Blob is empty';
                }
            } catch (error) {
                document.getElementById('result').innerHTML = '‚ùå Checkin error: ' + error.message;
                console.error('Checkin error:', error);
            }
        }
    </script>
</body>
</html>
