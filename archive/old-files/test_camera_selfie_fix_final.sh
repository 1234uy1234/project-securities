#!/bin/bash

echo "🔧 TEST CAMERA SELFIE FIX - FINAL VERSION"
echo "=========================================="

# Kiểm tra frontend đang chạy
echo "📱 Kiểm tra frontend..."
if curl -s -k https://10.10.68.200:5173 > /dev/null; then
    echo "✅ Frontend đang chạy trên https://10.10.68.200:5173"
else
    echo "❌ Frontend không chạy. Vui lòng khởi động frontend trước."
    exit 1
fi

# Kiểm tra backend đang chạy
echo "🔧 Kiểm tra backend..."
if curl -s -k https://10.10.68.200:8000/health > /dev/null; then
    echo "✅ Backend đang chạy trên https://10.10.68.200:8000"
else
    echo "❌ Backend không chạy. Vui lòng khởi động backend trước."
    exit 1
fi

echo ""
echo "🎯 HƯỚNG DẪN TEST CAMERA SELFIE - FIXED VERSION:"
echo "================================================"
echo ""
echo "1. 📱 Mở trình duyệt và truy cập:"
echo "   https://10.10.68.200:5173"
echo ""
echo "2. 🔐 Đăng nhập với tài khoản admin/manager/employee"
echo ""
echo "3. 📷 Test trên các trang:"
echo "   - QR Scanner: https://10.10.68.200:5173/qr-scan"
echo "   - Checkin: https://10.10.68.200:5173/checkin"
echo "   - Admin Dashboard: https://10.10.68.200:5173/admin-dashboard"
echo ""
echo "4. 🎯 Test camera selfie:"
echo "   - Quét QR code bất kỳ"
echo "   - Bấm 'Bật Camera' trong phần 'Chụp ảnh xác nhận'"
echo "   - Thử chuyển đổi giữa camera sau và camera selfie"
echo "   - Test chụp ảnh với camera selfie"
echo "   - Tắt camera và bật lại camera selfie"
echo ""
echo "5. 🧪 Test file HTML độc lập:"
echo "   Mở file: test_camera_selfie.html trong trình duyệt"
echo ""
echo "✅ CẢI TIẾN ĐÃ THỰC HIỆN:"
echo "========================"
echo ""
echo "1. 🌐 GlobalCameraManager - Quản lý tất cả camera streams"
echo "   - Dừng TẤT CẢ streams trước khi khởi động stream mới"
echo "   - Tránh xung đột giữa các camera components"
echo "   - Đảm bảo camera selfie không bị 'đang được sử dụng'"
echo ""
echo "2. 🔧 Cập nhật tất cả camera components:"
echo "   - SimpleMobileCamera (QR Scanner photo capture)"
echo "   - ScanCamera (QR Scanner)"
echo "   - StableCameraModal (Face auth)"
echo "   - CheckinPage camera functions"
echo "   - QRScannerPage camera functions"
echo ""
echo "3. 🛡️ Cải thiện xử lý lỗi:"
echo "   - Thông báo lỗi cụ thể cho camera selfie"
echo "   - Fallback constraints khi camera selfie thất bại"
echo "   - Timeout dài hơn cho camera selfie (5s)"
echo ""
echo "4. ⏱️ Tối ưu timing:"
echo "   - Delay 1s giữa việc dừng và khởi động camera"
echo "   - Đảm bảo stream cũ hoàn toàn dừng trước khi khởi động mới"
echo ""
echo "5. 🎯 useGlobalCamera hook:"
echo "   - Quản lý camera toàn cục trong tất cả components"
echo "   - Tự động cleanup khi component unmount"
echo ""
echo "🔍 CÁC LỖI ĐÃ SỬA:"
echo "=================="
echo ""
echo "❌ 'Camera selfie đang được sử dụng'"
echo "   ✅ FIXED: GlobalCameraManager dừng tất cả streams trước khi khởi động mới"
echo ""
echo "❌ Camera selfie timeout"
echo "   ✅ FIXED: Tăng timeout từ 3s → 5s, thêm fallback constraints"
echo ""
echo "❌ Xung đột giữa QR scanner và photo camera"
echo "   ✅ FIXED: Mỗi camera có ID riêng, quản lý tập trung"
echo ""
echo "❌ Camera không giải phóng hoàn toàn"
echo "   ✅ FIXED: Đợi 1s để đảm bảo stream dừng hoàn toàn"
echo ""
echo "🚀 BẮT ĐẦU TEST..."
echo "=================="
echo ""
echo "Mở trình duyệt và test theo hướng dẫn trên!"
echo ""
echo "📞 Nếu vẫn gặp lỗi, hãy:"
echo "   1. Kiểm tra console log trong DevTools"
echo "   2. Thử trên thiết bị khác"
echo "   3. Kiểm tra quyền camera trong trình duyệt"
echo "   4. Restart trình duyệt để clear cache"
echo ""
echo "🎉 Camera selfie bây giờ sẽ hoạt động ổn định!"
echo ""
