#!/bin/bash

echo "=== TEST TẠO TASK TỰ ĐỘNG THÀNH CÔNG ==="
echo ""

echo "1. Tasks hiện tại:"
sqlite3 backend/app.db "SELECT id, title, assigned_to, status FROM patrol_tasks ORDER BY id DESC LIMIT 3;"

echo ""
echo "2. Stops hiện tại:"
sqlite3 backend/app.db "SELECT task_id, location_id, qr_code_name, completed, completed_at FROM patrol_task_stops ORDER BY task_id DESC LIMIT 3;"

echo ""
echo "3. Checkin Records hiện tại:"
sqlite3 backend/app.db "SELECT id, task_id, user_id, check_in_time FROM patrol_records ORDER BY id DESC LIMIT 3;"

echo ""
echo "4. API Response cho task mới:"
curl -k -s "https://10.10.68.200:8000/api/patrol-tasks/" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsImV4cCI6MTc1OTMwOTQ4MH0.FsvT3xspBpWyVwupoEV3cSY1A2oKXO6yMdOLmX4zAkY" | \
  jq '.[] | select(.id == 53) | {id, title, assigned_to, status, stops: .stops[0]}'

echo ""
echo "=== ĐÃ SỬA THÀNH CÔNG ==="
echo "✅ Logic /checkin/simple đã được sửa"
echo "✅ Không còn báo lỗi 'Không tìm thấy vị trí'"
echo "✅ Luôn tạo task tự động khi checkin"
echo "✅ Task 53 được tạo với QR content 'test_location_new'"
echo "✅ Stop có qr_code_name đúng và completed = true"
echo "✅ Checkin record được tạo với ảnh"
echo ""
echo "=== KẾT QUẢ MONG ĐỢI ==="
echo "Bây giờ bạn có thể:"
echo "1. Tạo task bất kỳ bằng cách checkin với QR content mới"
echo "2. Task sẽ được tạo tự động với tên 'Nhiệm vụ tự động - [QR content]'"
echo "3. Stop sẽ có qr_code_name đúng"
echo "4. Ảnh sẽ được lưu và hiển thị"
echo "5. Admin Dashboard sẽ hiển thị task mới"
echo ""
echo "=== HƯỚNG DẪN TEST ==="
echo "1. Mở https://10.10.68.200:5173/admin-dashboard"
echo "2. Đăng nhập với admin/admin123"
echo "3. Hard refresh trang (Ctrl+Shift+R)"
echo "4. Sẽ thấy 3 tasks:"
echo "   - 'Test QR Nhà Xe' (admin) - completed"
echo "   - 'Nhiệm vụ tự động - nhà xe' (minh) - completed"
echo "   - 'Nhiệm vụ tự động - test_location_new' (admin) - completed"
echo "5. Tất cả đều hiển thị 'Đã chấm công' với đúng thời gian"
echo ""
echo "=== TEST THÊM ==="
echo "Bạn có thể test thêm bằng cách checkin với QR content khác:"
echo "curl -k -X POST 'https://10.10.68.200:8000/api/checkin/simple' \\"
echo "  -H 'Authorization: Bearer [token]' \\"
echo "  -F 'qr_data=location_abc' \\"
echo "  -F 'photo=@test_face.jpg'"
