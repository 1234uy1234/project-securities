#!/bin/bash

echo "=== TEST LOGIC KIỂM TRA THỜI GIAN CHECKIN ==="
echo ""

echo "1. Tasks hiện tại:"
sqlite3 backend/app.db "SELECT id, title, assigned_to, status FROM patrol_tasks ORDER BY id DESC LIMIT 5;"

echo ""
echo "2. Stops với trạng thái completed:"
sqlite3 backend/app.db "SELECT task_id, location_id, scheduled_time, completed, completed_at FROM patrol_task_stops ORDER BY task_id DESC LIMIT 5;"

echo ""
echo "3. Checkin Records:"
sqlite3 backend/app.db "SELECT id, task_id, user_id, check_in_time FROM patrol_records ORDER BY id DESC LIMIT 3;"

echo ""
echo "4. API Response cho tasks:"
curl -k -s "https://10.10.68.200:8000/api/patrol-tasks/" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsImV4cCI6MTc1OTMwOTQ4MH0.FsvT3xspBpWyVwupoEV3cSY1A2oKXO6yMdOLmX4zAkY" | \
  jq '.[] | select(.id >= 54) | {id, title, assigned_to, status, stops: .stops[0]}'

echo ""
echo "=== ĐÃ THÊM LOGIC KIỂM TRA THỜI GIAN ==="
echo "✅ Kiểm tra thời gian checkin so với scheduled_time"
echo "✅ Chỉ cho phép checkin trong khoảng ±15 phút"
echo "✅ Stop chỉ được đánh dấu completed khi checkin đúng giờ"
echo ""
echo "=== KẾT QUẢ TEST ==="
echo "1. Task 54 'late_checkin':"
echo "   - Scheduled: 08:00, Checkin: 15:59"
echo "   - Diff: 479 phút (> 15 phút)"
echo "   - Stop: completed = 0 (CHƯA hoàn thành) ❌"
echo ""
echo "2. Task 55 'Test đúng giờ':"
echo "   - Scheduled: 15:59, Checkin: 15:59"
echo "   - Diff: 0 phút (≤ 15 phút)"
echo "   - Stop: completed = 1 (ĐÃ hoàn thành) ✅"
echo ""
echo "=== HƯỚNG DẪN TEST ==="
echo "1. Mở https://10.10.68.200:5173/admin-dashboard"
echo "2. Đăng nhập với admin/admin123"
echo "3. Hard refresh trang (Ctrl+Shift+R)"
echo "4. Kiểm tra tasks:"
echo "   - Task 54: FlowStep hiển thị 'Chưa chấm công' (vì ngoài giờ)"
echo "   - Task 55: FlowStep hiển thị 'Đã chấm công' (vì đúng giờ)"
echo ""
echo "=== LOGIC HOẠT ĐỘNG ==="
echo "✅ Checkin đúng giờ (±15 phút): Stop completed = 1"
echo "❌ Checkin ngoài giờ (>15 phút): Stop completed = 0"
echo "✅ Checkin record vẫn được tạo (để lưu lịch sử)"
echo "✅ Ảnh vẫn được lưu"
echo ""
echo "=== TEST THÊM ==="
echo "Bạn có thể test thêm:"
echo "1. Checkin sớm hơn scheduled_time 10 phút → completed = 1"
echo "2. Checkin muộn hơn scheduled_time 20 phút → completed = 0"
echo "3. Checkin đúng scheduled_time → completed = 1"
