#!/bin/bash

echo "=== TEST MODAL CHI TIẾT CHẤM CÔNG MỚI ==="
echo ""

echo "1. Tasks với trạng thái completed:"
sqlite3 backend/app.db "SELECT pt.id, pt.title, pts.completed, pts.completed_at, pts.scheduled_time FROM patrol_tasks pt LEFT JOIN patrol_task_stops pts ON pt.id = pts.task_id WHERE pt.id >= 54 ORDER BY pt.id DESC;"

echo ""
echo "2. Checkin Records:"
sqlite3 backend/app.db "SELECT id, task_id, location_id, check_in_time FROM patrol_records WHERE task_id >= 54 ORDER BY id DESC;"

echo ""
echo "=== LOGIC MỚI HOẠT ĐỘNG ==="
echo "✅ Modal sẽ hiển thị đúng trạng thái dựa trên stop.completed"
echo "✅ Backend đã kiểm tra thời gian và set completed"
echo "✅ Frontend truyền thông tin stop status vào modal"
echo ""
echo "=== KẾT QUẢ MONG ĐỢI TRONG MODAL ==="
echo "1. Task 55 'Test đúng giờ':"
echo "   - stop.completed = true"
echo "   - Modal: '✅ Chấm công đúng giờ' (màu xanh)"
echo "   - Ảnh: Hiển thị ảnh hoặc 'Đã chấm công đúng giờ nhưng không có ảnh'"
echo ""
echo "2. Task 56 'fvbfhbv':"
echo "   - stop.completed = false"
echo "   - Modal: '⚠️ Chấm công ngoài giờ' (màu cam)"
echo "   - Ảnh: Hiển thị ảnh hoặc 'Đã chấm công ngoài giờ nhưng không có ảnh'"
echo ""
echo "3. Task 57 'nhà đi chơi':"
echo "   - stop.completed = null"
echo "   - Modal: 'Chưa chấm công' (màu đỏ)"
echo "   - Ảnh: 'Chưa chấm công'"
echo ""
echo "=== HƯỚNG DẪN TEST ==="
echo "1. Mở https://10.10.68.200:5173/admin-dashboard"
echo "2. Đăng nhập với admin/admin123"
echo "3. Hard refresh trang (Ctrl+Shift+R)"
echo "4. Click vào FlowStep của các tasks:"
echo "   - Task 55: Modal hiển thị '✅ Chấm công đúng giờ'"
echo "   - Task 56: Modal hiển thị '⚠️ Chấm công ngoài giờ'"
echo "   - Task 57: Modal hiển thị 'Chưa chấm công'"
echo ""
echo "=== LOGIC HOẠT ĐỘNG ==="
echo "✅ Backend kiểm tra thời gian checkin vs scheduled_time"
echo "✅ Chỉ set completed = 1 khi checkin trong ±15 phút"
echo "✅ Frontend truyền thông tin stop status vào modal"
echo "✅ Modal hiển thị đúng trạng thái với màu sắc phù hợp"
echo ""
echo "=== TEST THÊM ==="
echo "Bạn có thể test thêm:"
echo "1. Checkin sớm hơn scheduled_time 10 phút → Modal: '✅ Chấm công đúng giờ'"
echo "2. Checkin muộn hơn scheduled_time 20 phút → Modal: '⚠️ Chấm công ngoài giờ'"
echo "3. Checkin đúng scheduled_time → Modal: '✅ Chấm công đúng giờ'"