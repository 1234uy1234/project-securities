#!/bin/bash

echo "🔧 TEST CAMERA LOADING FIX"
echo "=========================="

echo "📱 Kiểm tra frontend..."
if curl -s -k https://10.10.68.200:5173 > /dev/null; then
    echo "✅ Frontend đang chạy trên https://10.10.68.200:5173"
else
    echo "❌ Frontend không chạy"
    exit 1
fi

echo "🔧 Kiểm tra backend..."
if curl -s -k https://10.10.68.200:8000/health > /dev/null; then
    echo "✅ Backend đang chạy trên https://10.10.68.200:8000"
else
    echo "❌ Backend không chạy"
    exit 1
fi

echo ""
echo "🎯 HƯỚNG DẪN TEST CAMERA LOADING FIX:"
echo "====================================="
echo ""
echo "1. 📱 Mở trình duyệt và truy cập:"
echo "   https://10.10.68.200:5173"
echo ""
echo "2. 🔐 Đăng nhập với tài khoản admin/manager/employee"
echo ""
echo "3. 📷 Test camera trên các trang:"
echo "   - QR Scanner: https://10.10.68.200:5173/qr-scan"
echo "   - Checkin: https://10.10.68.200:5173/checkin"
echo "   - Admin Dashboard: https://10.10.68.200:5173/admin-dashboard"
echo ""
echo "4. 🧪 Test file HTML đơn giản:"
echo "   Mở file: test_camera_simple.html trong trình duyệt"
echo "   (File này test camera với constraints cực kỳ đơn giản)"
echo ""
echo "✅ CẢI TIẾN ĐÃ THỰC HIỆN:"
echo "========================"
echo ""
echo "1. 🎯 Constraints đơn giản hơn:"
echo "   - Chỉ sử dụng facingMode, bỏ width/height/frameRate"
echo "   - Thử constraints đơn giản trước, fallback nếu thất bại"
echo ""
echo "2. ⏱️ Timing cải thiện:"
echo "   - Tăng delay giữa việc dừng và khởi động camera: 1s"
echo "   - Tăng timeout camera: 10s"
echo "   - Đợi video load metadata trước khi play"
echo ""
echo "3. 🔄 Fallback strategy:"
echo "   - Thử constraints đơn giản trước"
echo "   - Nếu thất bại, thử constraints gốc"
echo "   - Cuối cùng thử bất kỳ camera nào"
echo ""
echo "4. 📝 Logging chi tiết:"
echo "   - Log từng bước khởi động camera"
echo "   - Hiển thị constraints được sử dụng"
echo "   - Báo lỗi cụ thể nếu có"
echo ""
echo "🔍 CÁC LỖI ĐÃ SỬA:"
echo "=================="
echo ""
echo "❌ Camera báo 'đang khởi động' nhưng không hiển thị"
echo "   ✅ FIXED: Constraints đơn giản hơn, timeout dài hơn"
echo ""
echo "❌ Camera selfie không hoạt động"
echo "   ✅ FIXED: Thử constraints đơn giản trước"
echo ""
echo "❌ Camera timeout quá nhanh"
echo "   ✅ FIXED: Tăng timeout từ 3s → 10s"
echo ""
echo "❌ Xung đột giữa các camera streams"
echo "   ✅ FIXED: Dừng tất cả streams, đợi 1s trước khi khởi động mới"
echo ""
echo "🚀 BẮT ĐẦU TEST..."
echo "=================="
echo ""
echo "Mở trình duyệt và test theo hướng dẫn trên!"
echo ""
echo "📞 Nếu vẫn gặp lỗi, hãy:"
echo "   1. Mở DevTools (F12) và xem Console log"
echo "   2. Test file test_camera_simple.html trước"
echo "   3. Kiểm tra quyền camera trong trình duyệt"
echo "   4. Thử trên thiết bị khác"
echo ""
echo "🎉 Camera bây giờ sẽ hiển thị ngay khi khởi động!"
