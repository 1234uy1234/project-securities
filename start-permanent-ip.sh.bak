#!/bin/bash

echo "🚀 KHỞI ĐỘNG DỰ ÁN VỚI IP CỐ ĐỊNH VĨNH VIỄN"
echo "============================================="

# IP cố định vĩnh viễn
FIXED_IP="10.10.68.72"

echo "📍 IP cố định: $FIXED_IP"
echo "🔒 IP này đã được cố định VĨNH VIỄN và sẽ KHÔNG BAO GIỜ thay đổi!"
echo ""

# Kiểm tra IP hiện tại
CURRENT_IP=$(ifconfig en0 | grep "inet " | grep -v 127.0.0.1 | awk '{print $2}')
echo "🔍 IP hiện tại: $CURRENT_IP"

if [ "$CURRENT_IP" != "$FIXED_IP" ]; then
    echo "⚠️  CẢNH BÁO: IP hiện tại ($CURRENT_IP) khác với IP cố định ($FIXED_IP)"
    echo "🔧 Chạy script cố định IP trước:"
    echo "   sudo ./fix-ip-permanently.sh"
    echo ""
    read -p "Bạn có muốn tiếp tục với IP hiện tại không? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "❌ Dừng khởi động. Vui lòng cố định IP trước."
        exit 1
    fi
fi

echo "🛑 Dừng các process cũ..."
pkill -f "python.*app" 2>/dev/null
pkill -f "npm.*dev" 2>/dev/null
pkill -f "uvicorn" 2>/dev/null
pkill -f "vite" 2>/dev/null
sleep 3

# Khởi động backend với IP cố định
echo "🔧 Khởi động Backend với IP cố định..."
cd backend
python -m uvicorn app.main:app --host $FIXED_IP --port 8000 --ssl-keyfile ../ssl/server.key --ssl-certfile ../ssl/server.crt &
BACKEND_PID=$!

# Đợi backend khởi động
echo "⏳ Đợi backend khởi động..."
sleep 5

# Khởi động frontend với IP cố định
echo "🎨 Khởi động Frontend với IP cố định..."
cd ../frontend
VITE_API_BASE_URL=https://$FIXED_IP:8000 npm run dev -- --host localhost --port 5173 --https &
FRONTEND_PID=$!

# Đợi frontend khởi động
echo "⏳ Đợi frontend khởi động..."
sleep 8

# Test kết nối
echo "🔍 Test kết nối..."
curl -k -s "https://$FIXED_IP:8000/health" >/dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "✅ Backend HTTPS: OK"
else
    echo "❌ Backend HTTPS: FAIL"
fi

curl -k -s -I "https://localhost:5173" >/dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "✅ Frontend HTTPS: OK"
else
    echo "⚠️  Frontend HTTPS: SSL Warning (vẫn hoạt động)"
fi

echo ""
echo "🎯 DỰ ÁN ĐÃ KHỞI ĐỘNG VỚI IP CỐ ĐỊNH VĨNH VIỄN:"
echo "   Frontend: https://localhost:5173"
echo "   Backend:  https://$FIXED_IP:8000"
echo "   API Docs: https://$FIXED_IP:8000/docs"
echo ""
echo "🔐 Thông tin đăng nhập:"
echo "   Username: admin"
echo "   Password: admin123"
echo ""
echo "🔒 IP $FIXED_IP ĐÃ ĐƯỢC CỐ ĐỊNH VĨNH VIỄN!"
echo "📱 Để dừng ứng dụng, nhấn Ctrl+C"

# Cleanup function
cleanup() {
    echo ""
    echo "🛑 Đang dừng ứng dụng..."
    kill $BACKEND_PID 2>/dev/null
    kill $FRONTEND_PID 2>/dev/null
    pkill -f "uvicorn" 2>/dev/null
    pkill -f "npm.*dev" 2>/dev/null
    echo "✅ Đã dừng tất cả services"
    exit
}

trap cleanup SIGINT SIGTERM

# Keep script running
wait
