#!/bin/bash

echo "ğŸš€ KHá»I Äá»˜NG Dá»° ÃN Vá»šI IP Cá» Äá»ŠNH VÄ¨NH VIá»„N"
echo "============================================="

# IP cá»‘ Ä‘á»‹nh vÄ©nh viá»…n
FIXED_IP="10.10.68.72"

echo "ğŸ“ IP cá»‘ Ä‘á»‹nh: $FIXED_IP"
echo "ğŸ”’ IP nÃ y Ä‘Ã£ Ä‘Æ°á»£c cá»‘ Ä‘á»‹nh VÄ¨NH VIá»„N vÃ  sáº½ KHÃ”NG BAO GIá»œ thay Ä‘á»•i!"
echo ""

# Kiá»ƒm tra IP hiá»‡n táº¡i
CURRENT_IP=$(ifconfig en0 | grep "inet " | grep -v 127.0.0.1 | awk '{print $2}')
echo "ğŸ” IP hiá»‡n táº¡i: $CURRENT_IP"

if [ "$CURRENT_IP" != "$FIXED_IP" ]; then
    echo "âš ï¸  Cáº¢NH BÃO: IP hiá»‡n táº¡i ($CURRENT_IP) khÃ¡c vá»›i IP cá»‘ Ä‘á»‹nh ($FIXED_IP)"
    echo "ğŸ”§ Cháº¡y script cá»‘ Ä‘á»‹nh IP trÆ°á»›c:"
    echo "   sudo ./fix-ip-permanently.sh"
    echo ""
    read -p "Báº¡n cÃ³ muá»‘n tiáº¿p tá»¥c vá»›i IP hiá»‡n táº¡i khÃ´ng? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "âŒ Dá»«ng khá»Ÿi Ä‘á»™ng. Vui lÃ²ng cá»‘ Ä‘á»‹nh IP trÆ°á»›c."
        exit 1
    fi
fi

echo "ğŸ›‘ Dá»«ng cÃ¡c process cÅ©..."
pkill -f "python.*app" 2>/dev/null
pkill -f "npm.*dev" 2>/dev/null
pkill -f "uvicorn" 2>/dev/null
pkill -f "vite" 2>/dev/null
sleep 3

# Khá»Ÿi Ä‘á»™ng backend vá»›i IP cá»‘ Ä‘á»‹nh
echo "ğŸ”§ Khá»Ÿi Ä‘á»™ng Backend vá»›i IP cá»‘ Ä‘á»‹nh..."
cd backend
python -m uvicorn app.main:app --host $FIXED_IP --port 8000 --ssl-keyfile ../ssl/server.key --ssl-certfile ../ssl/server.crt &
BACKEND_PID=$!

# Äá»£i backend khá»Ÿi Ä‘á»™ng
echo "â³ Äá»£i backend khá»Ÿi Ä‘á»™ng..."
sleep 5

# Khá»Ÿi Ä‘á»™ng frontend vá»›i IP cá»‘ Ä‘á»‹nh
echo "ğŸ¨ Khá»Ÿi Ä‘á»™ng Frontend vá»›i IP cá»‘ Ä‘á»‹nh..."
cd ../frontend
VITE_API_BASE_URL=https://$FIXED_IP:8000 npm run dev -- --host localhost --port 5173 --https &
FRONTEND_PID=$!

# Äá»£i frontend khá»Ÿi Ä‘á»™ng
echo "â³ Äá»£i frontend khá»Ÿi Ä‘á»™ng..."
sleep 8

# Test káº¿t ná»‘i
echo "ğŸ” Test káº¿t ná»‘i..."
curl -k -s "https://$FIXED_IP:8000/health" >/dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "âœ… Backend HTTPS: OK"
else
    echo "âŒ Backend HTTPS: FAIL"
fi

curl -k -s -I "https://localhost:5173" >/dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "âœ… Frontend HTTPS: OK"
else
    echo "âš ï¸  Frontend HTTPS: SSL Warning (váº«n hoáº¡t Ä‘á»™ng)"
fi

echo ""
echo "ğŸ¯ Dá»° ÃN ÄÃƒ KHá»I Äá»˜NG Vá»šI IP Cá» Äá»ŠNH VÄ¨NH VIá»„N:"
echo "   Frontend: https://localhost:5173"
echo "   Backend:  https://$FIXED_IP:8000"
echo "   API Docs: https://$FIXED_IP:8000/docs"
echo ""
echo "ğŸ” ThÃ´ng tin Ä‘Äƒng nháº­p:"
echo "   Username: admin"
echo "   Password: admin123"
echo ""
echo "ğŸ”’ IP $FIXED_IP ÄÃƒ ÄÆ¯á»¢C Cá» Äá»ŠNH VÄ¨NH VIá»„N!"
echo "ğŸ“± Äá»ƒ dá»«ng á»©ng dá»¥ng, nháº¥n Ctrl+C"

# Cleanup function
cleanup() {
    echo ""
    echo "ğŸ›‘ Äang dá»«ng á»©ng dá»¥ng..."
    kill $BACKEND_PID 2>/dev/null
    kill $FRONTEND_PID 2>/dev/null
    pkill -f "uvicorn" 2>/dev/null
    pkill -f "npm.*dev" 2>/dev/null
    echo "âœ… ÄÃ£ dá»«ng táº¥t cáº£ services"
    exit
}

trap cleanup SIGINT SIGTERM

# Keep script running
wait
