#!/usr/bin/env python3
"""
Script Ä‘á»ƒ khá»Ÿi Ä‘á»™ng backend vá»›i ngrok tá»± Ä‘á»™ng
Tá»± Ä‘á»™ng táº¡o public HTTPS URL vÃ  cáº­p nháº­t file .env
"""

import subprocess
import time
import json
import os
import sys
import threading
from pathlib import Path

def get_ngrok_url():
    """Láº¥y ngrok URL tá»« API"""
    try:
        import requests
        response = requests.get('http://localhost:4040/api/tunnels')
        data = response.json()
        
        for tunnel in data.get('tunnels', []):
            if tunnel.get('proto') == 'https':
                return tunnel.get('public_url')
    except Exception as e:
        print(f"âŒ Lá»—i láº¥y ngrok URL: {e}")
    return None

def update_env_file(ngrok_url):
    """Cáº­p nháº­t file .env vá»›i ngrok URL"""
    env_file = Path('.env')
    
    # Äá»c file .env hiá»‡n táº¡i
    env_vars = {}
    if env_file.exists():
        with open(env_file, 'r') as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith('#') and '=' in line:
                    key, value = line.split('=', 1)
                    env_vars[key] = value
    
    # Cáº­p nháº­t NGROK_URL
    env_vars['NGROK_URL'] = ngrok_url
    env_vars['VITE_API_URL'] = ngrok_url
    
    # Ghi láº¡i file .env
    with open(env_file, 'w') as f:
        f.write("# Auto-generated by start-with-ngrok.py\n")
        f.write(f"NGROK_URL={ngrok_url}\n")
        f.write(f"VITE_API_URL={ngrok_url}\n")
        f.write("\n# Other environment variables\n")
        for key, value in env_vars.items():
            if key not in ['NGROK_URL', 'VITE_API_URL']:
                f.write(f"{key}={value}\n")
    
    print(f"âœ… ÄÃ£ cáº­p nháº­t file .env vá»›i NGROK_URL={ngrok_url}")

def start_ngrok(port=8000):
    """Khá»Ÿi Ä‘á»™ng ngrok"""
    print(f"ğŸš€ Äang khá»Ÿi Ä‘á»™ng ngrok cho port {port}...")
    
    # Khá»Ÿi Ä‘á»™ng ngrok
    ngrok_process = subprocess.Popen([
        'ngrok', 'http', str(port),
        '--log=stdout'
    ], stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    
    # Äá»£i ngrok khá»Ÿi Ä‘á»™ng
    time.sleep(3)
    
    # Láº¥y URL tá»« ngrok
    max_retries = 10
    for i in range(max_retries):
        ngrok_url = get_ngrok_url()
        if ngrok_url:
            print(f"âœ… Ngrok Ä‘Ã£ khá»Ÿi Ä‘á»™ng thÃ nh cÃ´ng!")
            print(f"ğŸŒ Public URL: {ngrok_url}")
            print(f"ğŸ”— Backend URL: {ngrok_url}")
            print(f"ğŸ“± Frontend sáº½ sá»­ dá»¥ng: {ngrok_url}")
            
            # Cáº­p nháº­t file .env
            update_env_file(ngrok_url)
            
            return ngrok_process, ngrok_url
        
        print(f"â³ Äang Ä‘á»£i ngrok khá»Ÿi Ä‘á»™ng... ({i+1}/{max_retries})")
        time.sleep(2)
    
    print("âŒ KhÃ´ng thá»ƒ láº¥y ngrok URL sau 20 giÃ¢y")
    return None, None

def start_backend():
    """Khá»Ÿi Ä‘á»™ng backend"""
    print("ğŸ Äang khá»Ÿi Ä‘á»™ng backend...")
    
    # Kiá»ƒm tra xem cÃ³ file main.py hay app.py
    backend_files = ['backend/app/main.py', 'backend/main.py', 'app.py', 'main.py']
    backend_file = None
    
    for file in backend_files:
        if os.path.exists(file):
            backend_file = file
            break
    
    if not backend_file:
        print("âŒ KhÃ´ng tÃ¬m tháº¥y file backend!")
        return None
    
    print(f"ğŸ“ Sá»­ dá»¥ng file backend: {backend_file}")
    
    # Khá»Ÿi Ä‘á»™ng backend
    if backend_file.endswith('.py'):
        backend_process = subprocess.Popen([
            sys.executable, backend_file
        ], cwd=os.path.dirname(backend_file) if os.path.dirname(backend_file) else '.')
    else:
        backend_process = subprocess.Popen([backend_file])
    
    return backend_process

def main():
    """HÃ m chÃ­nh"""
    print("ğŸ¯ Khá»Ÿi Ä‘á»™ng há»‡ thá»‘ng vá»›i ngrok...")
    print("=" * 50)
    
    # Khá»Ÿi Ä‘á»™ng backend trÆ°á»›c
    backend_process = start_backend()
    if not backend_process:
        return
    
    # Äá»£i backend khá»Ÿi Ä‘á»™ng
    print("â³ Äá»£i backend khá»Ÿi Ä‘á»™ng...")
    time.sleep(5)
    
    # Khá»Ÿi Ä‘á»™ng ngrok
    ngrok_process, ngrok_url = start_ngrok(8000)
    if not ngrok_process:
        print("âŒ KhÃ´ng thá»ƒ khá»Ÿi Ä‘á»™ng ngrok")
        backend_process.terminate()
        return
    
    print("\n" + "=" * 50)
    print("ğŸ‰ Há»‡ thá»‘ng Ä‘Ã£ khá»Ÿi Ä‘á»™ng thÃ nh cÃ´ng!")
    print(f"ğŸŒ Public URL: {ngrok_url}")
    print("ğŸ“± BÃ¢y giá» báº¡n cÃ³ thá»ƒ truy cáº­p tá»« báº¥t ká»³ Ä‘Ã¢u!")
    print("\nğŸ’¡ Äá»ƒ dá»«ng há»‡ thá»‘ng, nháº¥n Ctrl+C")
    print("=" * 50)
    
    try:
        # Giá»¯ script cháº¡y
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        print("\nğŸ›‘ Äang dá»«ng há»‡ thá»‘ng...")
        backend_process.terminate()
        ngrok_process.terminate()
        print("âœ… ÄÃ£ dá»«ng há»‡ thá»‘ng")

if __name__ == "__main__":
    main()

